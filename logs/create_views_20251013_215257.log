2025-10-13 21:52:57,339 - INFO - ============================================================
2025-10-13 21:52:57,339 - INFO - Creating database views for municipal merger handling
2025-10-13 21:52:57,339 - INFO - ============================================================
2025-10-13 21:52:57,339 - INFO - Connecting to database: data/swiss_votings.db
2025-10-13 21:52:57,339 - INFO - Creating simplified municipality mapping view...
2025-10-13 21:52:57,363 - INFO - Simplified municipality mapping view created successfully
2025-10-13 21:52:57,363 - INFO - Creating municipality mapping view...
2025-10-13 21:52:57,386 - INFO - Municipality mapping view created successfully
2025-10-13 21:52:57,386 - INFO - Creating current voting results view...
2025-10-13 21:52:57,409 - INFO - Current voting results view created successfully
2025-10-13 21:52:57,409 - INFO - Creating municipality evolution view...
2025-10-13 21:52:57,432 - INFO - Municipality evolution view created successfully
2025-10-13 21:52:57,432 - INFO - Creating voting comparison view...
2025-10-13 21:52:57,452 - INFO - Voting comparison view created successfully
2025-10-13 21:52:57,452 - INFO - Creating indexes for view performance...
2025-10-13 21:52:57,453 - INFO - Indexes created successfully
2025-10-13 21:52:57,453 - INFO - Verifying views...
2025-10-13 21:52:58,770 - INFO - Municipality mappings: 2123 total, 2123 historical → 2123 current
2025-10-13 21:52:58,770 - INFO - Maximum merger depth: 20 levels
2025-10-13 21:53:01,936 - INFO - Current voting results: 472041 records, 78 votings, 223 proposals
2025-10-13 21:53:01,936 - INFO - Current municipalities: 2123, max merged: 1
2025-10-13 21:53:03,256 - INFO - 
Sample of merged municipalities (cascading mergers):
2025-10-13 21:53:03,256 - INFO -   1001 Doppleschwand → 1001 Doppleschwand (depth: 20)
2025-10-13 21:53:03,256 - INFO -   1002 Entlebuch → 1002 Entlebuch (depth: 20)
2025-10-13 21:53:03,256 - INFO -   1004 Flühli → 1004 Flühli (depth: 20)
2025-10-13 21:53:03,256 - INFO -   1005 Hasle (LU) → 1005 Hasle (LU) (depth: 20)
2025-10-13 21:53:03,256 - INFO -   1007 Romoos → 1007 Romoos (depth: 20)
2025-10-13 21:53:04,980 - INFO - 
Votings most affected by mergers:
2025-10-13 21:53:04,980 - INFO - 
============================================================
2025-10-13 21:53:04,980 - INFO - EXAMPLE QUERIES FOR USING THE VIEWS
2025-10-13 21:53:04,980 - INFO - ============================================================
2025-10-13 21:53:04,980 - INFO - 
Get current voting results for a specific proposal:
2025-10-13 21:53:04,980 - INFO - 
SELECT
    municipality_id,
    municipality_name,
    ja_stimmen_absolut,
    nein_stimmen_absolut,
    ja_prozent,
    stimmbeteiligung,
    merged_municipality_count
FROM v_voting_results_current
WHERE proposal_id = 123
ORDER BY ja_prozent DESC;
2025-10-13 21:53:04,980 - INFO - 
Find all municipalities that merged into a specific one:
2025-10-13 21:53:04,980 - INFO - 
SELECT
    original_bfs,
    original_name,
    current_bfs,
    current_name
FROM v_municipality_mapping_simple
WHERE current_bfs = '351';  -- Example: Zurich
2025-10-13 21:53:04,980 - INFO - 
Track evolution of a specific municipality:
2025-10-13 21:53:04,980 - INFO - 
SELECT *
FROM v_municipality_evolution
WHERE old_bfs_number = '5586' OR new_bfs_number = '5586'
ORDER BY mutation_date;
2025-10-13 21:53:04,980 - INFO - 
Compare voting patterns before and after merger:
2025-10-13 21:53:04,980 - INFO - 
SELECT
    voting_date,
    municipality_id,
    municipality_name,
    AVG(ja_prozent) as avg_yes_percent,
    AVG(stimmbeteiligung) as avg_turnout,
    COUNT(DISTINCT proposal_id) as proposals_count,
    SUM(merged_municipality_count) - COUNT(*) as additional_merged
FROM v_voting_results_current
WHERE municipality_id IN (
    SELECT DISTINCT current_bfs
    FROM v_municipality_mapping_simple
    WHERE total_mergers > 0
)
GROUP BY voting_date, municipality_id, municipality_name
ORDER BY voting_date DESC;
2025-10-13 21:53:04,980 - INFO - 
Get all voting results with current municipal structure:
2025-10-13 21:53:04,980 - INFO - 
SELECT *
FROM v_voting_results_current
WHERE voting_date = '20240609'
ORDER BY municipality_name;
2025-10-13 21:53:04,981 - INFO - 
Database connection closed
2025-10-13 21:53:04,981 - INFO - ============================================================
2025-10-13 21:53:04,981 - INFO - Views created successfully!
2025-10-13 21:53:04,981 - INFO - Use v_voting_results_current for all voting data with current municipalities
2025-10-13 21:53:04,981 - INFO - ============================================================
