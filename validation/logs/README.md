# Validation Server Logs

This directory contains log files generated by the validation web server.

## Log Files

### 1. `validation_server_*.log` - Main Server Log
Contains all server activities including:
- Server startup information
- Database queries
- JSON file reads
- Data processing steps
- Error messages
- Detailed comparison operations

**Example:**
```
[2025-10-14T18:14:50.431Z] === COMPARISON REQUEST: 20190519 / 5226 ===
[2025-10-14T18:14:50.431Z] Fetching aggregated results: voting=20190519, municipality=5226
[2025-10-14T18:14:50.894Z] Retrieved 2 aggregated proposals for 5226
[2025-10-14T18:14:50.894Z]   Source municipalities: 5226,5236,5237
[2025-10-14T18:14:50.894Z]   Source count: 3
[2025-10-14T18:14:51.345Z]   Found Capriasca (5226): 1384 Ja, 861 Nein
[2025-10-14T18:14:51.345Z]   Found Collina d'Oro (5236): 940 Ja, 436 Nein
[2025-10-14T18:14:51.346Z]   Found Alto Malcantone (5237): 357 Ja, 190 Nein
```

### 2. `requests_*.log` - HTTP Request Log
Tracks all HTTP requests to the server:
- API endpoint calls
- Static file requests
- Request timestamps

**Example:**
```
[2025-10-14T18:14:50.431Z] GET /api/compare/20190519/5226
[2025-10-14T18:14:50.431Z] API: /api/compare/20190519/5226 called
```

### 3. `comparisons_*.log` - Comparison Results Log
Detailed JSON-formatted comparison results including:
- Voting date and municipality
- Number of proposals processed
- Source municipalities
- Validation status (PERFECT_MATCH or MISMATCH)
- Match/mismatch counts

**Example:**
```json
{
  "timestamp": "2025-10-14T18:14:51.346Z",
  "voting_date": "20190519",
  "municipality_id": "5226",
  "municipality_name": "Capriasca",
  "aggregated_count": 2,
  "original_count": 2,
  "changes_count": 11,
  "source_municipalities": "5226,5236,5237",
  "validation": {
    "status": "PERFECT_MATCH",
    "matches": 2,
    "mismatches": 0
  }
}
```

## File Naming Convention

Log files are named with timestamps to allow multiple server sessions:
- `validation_server_YYYY-MM-DDTHH-MM-SS.log`
- `requests_YYYY-MM-DDTHH-MM-SS.log`
- `comparisons_YYYY-MM-DDTHH-MM-SS.log`

Each server restart creates a new set of log files with a new timestamp.

## How to Use Logs

### Debugging Comparison Issues
1. Check `validation_server_*.log` for detailed step-by-step processing
2. Look for "Found" entries to see which municipalities were found in JSON
3. Check source_bfs_numbers to verify correct municipality mapping

### Monitoring Server Activity
1. Check `requests_*.log` to see all API calls
2. Track which endpoints are being used most frequently
3. Identify any 404 errors or missing endpoints

### Verifying Data Quality
1. Check `comparisons_*.log` for validation results
2. Look for "PERFECT_MATCH" status (good) vs "MISMATCH" status (needs investigation)
3. Review matches/mismatches counts for each comparison

### Troubleshooting Mergers
1. Search for municipality ID in `validation_server_*.log`
2. Look for "Found X merger changes" to see total mergers
3. Check "Source municipalities" to verify aggregation logic
4. Review individual municipality vote counts to manually verify totals

## Example Log Analysis

To find all comparisons for a specific municipality:
```bash
grep "5226" comparisons_*.log
```

To see all perfect matches:
```bash
grep "PERFECT_MATCH" comparisons_*.log
```

To find any errors:
```bash
grep "ERROR" validation_server_*.log
```

To check the most recent comparison:
```bash
tail -20 validation_server_*.log
```

## Log Retention

Log files accumulate with each server restart. To clean up old logs:
```bash
# Remove logs older than 7 days
find validation/logs -name "*.log" -mtime +7 -delete
```

Or manually remove old log files you no longer need.

---

**Note:** All log files use ISO 8601 timestamps with millisecond precision for accurate timing analysis.
